# MPSv3 Service Specifications
# Based on proven guardian/launcher configuration
# Author: Nicolas (Operational Configuration)
# Date: 2025-10-25

env:
  WS_PORT: "8000"
  DASHBOARD_PORT: "3000"
  MP_HOT_RELOAD: "1"
  MP_PERSIST_ENABLED: "1"
  MP_PERSIST_MIN_BATCH: "5"
  MP_PERSIST_INTERVAL_SEC: "5.0"

services:
  - id: falkordb
    cmd: ["cmd", "/c", "docker", "start", "-a", "falkordb"]
    restart: { policy: "always", backoff: { base_ms: 1000, max_ms: 30000, jitter: true } }
    readiness:
      tcp: { host: "127.0.0.1", port: 6379, timeout_s: 3 }
    singleton: true

  - id: ws_api
    cmd: ["python", "-m", "orchestration.adapters.ws.websocket_server"]
    env: { WS_PORT: "${WS_PORT}", MP_HOT_RELOAD: "${MP_HOT_RELOAD}", MP_PERSIST_ENABLED: "${MP_PERSIST_ENABLED}" }
    requires: ["falkordb"]
    readiness:
      http_get: { url: "http://127.0.0.1:${WS_PORT}/healthz?selftest=1", timeout_s: 10 }
    liveness:
      http_get: { url: "http://127.0.0.1:${WS_PORT}/healthz", timeout_s: 3 }
    restart: { policy: "always", backoff: { base_ms: 500, max_ms: 60000, jitter: true } }
    watch:
      paths: ["orchestration/mechanisms", "orchestration/core", "orchestration/adapters", "orchestration/libs"]
      on_change: "graceful-restart"
    singleton: true

  - id: dashboard
    cmd: ["cmd", "/c", "npm", "run", "dev"]
    cwd: "."
    env: { PORT: "${DASHBOARD_PORT}" }
    requires: ["ws_api"]
    readiness:
      http_get: { url: "http://127.0.0.1:${DASHBOARD_PORT}", timeout_s: 30 }
    restart: { policy: "always", backoff: { base_ms: 1000, max_ms: 60000, jitter: true } }
    watch:
      paths: ["app", "package.json", "next.config.*"]
      on_change: "graceful-restart"
    singleton: true

  - id: conversation_watcher
    cmd: ["python", "-m", "orchestration.services.watchers.conversation_watcher"]
    requires: ["ws_api"]
    restart: { policy: "always", backoff: { base_ms: 1000, max_ms: 60000, jitter: true } }
    singleton: true

  - id: stimulus_injection
    cmd: ["python", "-m", "orchestration.services.stimulus_injection"]
    requires: ["ws_api"]
    restart: { policy: "always", backoff: { base_ms: 1000, max_ms: 60000, jitter: true } }
    singleton: true

  - id: signals_collector
    cmd: ["python", "-m", "orchestration.services.signals_collector"]
    requires: ["ws_api"]
    restart: { policy: "always", backoff: { base_ms: 1000, max_ms: 60000, jitter: true } }
    singleton: true

  - id: autonomy_orchestrator
    cmd: ["python", "-m", "orchestration.services.autonomy_orchestrator"]
    requires: ["ws_api"]
    restart: { policy: "always", backoff: { base_ms: 1000, max_ms: 60000, jitter: true } }
    singleton: true
