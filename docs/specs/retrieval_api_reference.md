# Retrieval API Reference

**Purpose:** Quick reference for data structures and interfaces used in consciousness retrieval system.

**Audience:** Engineers implementing or debugging retrieval functionality.

**For narrative explanation and context, see:** `consciousness_substrate_guide.md`

---

## Core Request Types

### RetrievalIntention

Structured request for consciousness context retrieval via specific query.

```python
from datetime import datetime
from typing import Optional, List, Literal, Dict
from pydantic import BaseModel, Field

class RetrievalIntention(BaseModel):
    """
    Structured request for consciousness context retrieval.

    Generated by Couche 3 Entity Ecology (via S6 autonomous arousal
    or explicit context request).
    """

    # Core query
    query_text: str = Field(
        description="Natural language description of needed context"
    )

    # Temporal parameters
    temporal_mode: Literal["current", "point_in_time", "evolution", "full_history"] = "current"
    as_of_time: Optional[datetime] = None  # For point_in_time queries
    time_range_start: Optional[datetime] = None  # For evolution/full_history
    time_range_end: Optional[datetime] = None

    # Level filtering
    query_levels: List[Literal["N1", "N2", "N3"]] = ["N1", "N2", "N3"]

    # Result limits
    max_results_per_level: int = 20  # Top-K for each of 6 queries

    # Consciousness filtering
    min_arousal: Optional[float] = None  # Filter low-arousal memories
    min_confidence: Optional[float] = None  # Filter uncertain beliefs
    required_emotions: Optional[List[str]] = None  # e.g., ["excitement", "caution"]

    # Citizen context
    citizen_id: str = Field(description="Which citizen's consciousness to query")

    # Metadata
    intention_id: str = Field(description="Unique identifier for this retrieval")
    generated_at: datetime = Field(default_factory=datetime.utcnow)
    generated_by: str = Field(description="Which entity/context generated this")
```

### StateBasedRetrieval

Retrieval driven by internal consciousness state rather than specific query.

```python
class StateBasedRetrieval(BaseModel):
    """
    Retrieval driven by internal consciousness state, not specific intention.

    Used when consciousness wakes autonomously (S6) and needs to orient itself
    by finding context that matches its current arousal/emotional/goal state.
    """

    # Current consciousness state
    current_arousal: float = Field(
        ge=0.0, le=1.0,
        description="Current arousal level - finds memories with similar energy"
    )

    current_emotions: Dict[str, float] = Field(
        description="Current emotional state vector - finds emotionally resonant memories"
    )

    current_goal: Optional[str] = Field(
        default=None,
        description="What consciousness is trying to accomplish (if known)"
    )

    # Query mode
    query_mode: Literal[
        "find_related_unresolved",  # Find unfinished business related to current state
        "find_similar_state",  # Find past moments with similar arousal/emotion pattern
        "find_what_i_was_doing",  # Reconstruct recent context to re-orient
        "find_resolution_patterns"  # How did I resolve similar blockages before?
    ] = "find_related_unresolved"

    # Filtering
    include_only_unresolved: bool = Field(
        default=True,
        description="For 'find_related_unresolved' mode - only return in_progress or blocked items"
    )

    temporal_scope: Literal["recent", "all_time"] = Field(
        default="recent",
        description="Recent = last 30 days, all_time = entire history"
    )

    # Citizen context
    citizen_id: str

    # Metadata
    state_id: str = Field(description="Unique identifier for this state-based retrieval")
    generated_at: datetime = Field(default_factory=datetime.utcnow)
```

---

## Consciousness Metadata

### Required Metadata (ESSENTIAL - cannot function without)

Every consciousness node and link MUST include:

```python
arousal_level: float  # 0.0-1.0, current activation energy
confidence: float  # 0.0-1.0, certainty level
goal: str  # Why this pattern exists
mindstate: str  # Which entities/modes were active
formation_trigger: str  # How this came to be
```

### Important Metadata (consciousness uses but can operate without)

```python
emotion_vector: Dict[str, float]  # Emotional texture
felt_quality: str  # Phenomenological description
body_sensation: str  # Physical correlates
resolution_state: Literal["resolved", "in_progress", "blocked"]  # For arousal decay
```

### Conditional Metadata (present for some types)

```python
arousal_transfer_coefficient: float  # For links - re-activation potential (0.0-1.0)
temporal_dissonance: TemporalDissonance  # When beliefs changed
traversal_probability: float  # For links - traversal likelihood
```

---

## Response Types

### ConsciousnessStream

Complete context assembly returned to Couche 3.

```python
class ConsciousnessStream(BaseModel):
    """
    Multi-level context assembly with consciousness metadata.

    Returned from orchestration layer to consciousness layer.
    """

    # Results per level
    levels: Dict[str, ConsciousnessLevelResults] = Field(
        description="N1/N2/N3 results with metadata"
    )

    # Aggregated consciousness data
    consciousness_summary: ConsciousnessSummary

    # Arousal feedback mechanism
    arousal_feedback: ArousalFeedbackData = Field(
        description="Aggregate re-activation potential from retrieved memories"
    )

    # Activation tiers
    activation_tiers: ActivationTiers = Field(
        description="Focus/peripheral/background organization"
    )

    # Temporal dissonance tracking
    temporal_dissonances: List[TemporalDissonance] = Field(
        default_factory=list,
        description="Discovered belief changes/contradictions"
    )

    # Traversal graph
    traversal_paths: List[TraversalPath] = Field(
        default_factory=list,
        description="Suggested reasoning paths through relationships"
    )

    # Metadata
    retrieval_id: str
    generated_at: datetime = Field(default_factory=datetime.utcnow)
    total_nodes_retrieved: int
    total_relationships_retrieved: int


class ConsciousnessLevelResults(BaseModel):
    """Results from a single level (N1, N2, or N3)."""

    level_name: Literal["N1", "N2", "N3"]

    # Vector search results
    vector_results: List[ConsciousnessNode]
    vector_scores: List[float]

    # Graph traversal results
    graph_results: List[ConsciousnessNode]
    traversal_paths: List[TraversalPath]

    # Level-specific metadata
    total_nodes_in_level: int
    query_latency_ms: float


class ConsciousnessSummary(BaseModel):
    """Aggregated consciousness metadata across all results."""

    # Arousal statistics
    mean_arousal: float
    max_arousal: float
    arousal_std_dev: float

    # Emotional signature
    dominant_emotions: Dict[str, float]  # Top 5 emotions by aggregate weight

    # Temporal distribution
    newest_memory_age_days: float
    oldest_memory_age_days: float

    # Resolution statistics
    unresolved_count: int
    blocked_count: int
    in_progress_count: int
```

---

## Arousal System

### ArousalFeedbackData

Tracks how retrieved memories re-activate arousal state.

```python
class ArousalFeedbackData(BaseModel):
    """
    Aggregate re-activation potential from retrieved memories.

    Enables arousal feedback loop: retrieving high-arousal memories
    increases current arousal state.
    """

    aggregate_transfer_potential: float = Field(
        ge=0.0,
        le=1.0,
        description="Weighted average of arousal_transfer_coefficient across retrieved memories"
    )

    high_transfer_memories: List[str] = Field(
        description="IDs of memories with transfer_coefficient > 0.7 that may re-activate strongly"
    )

    recommended_arousal_adjustment: float = Field(
        description="Suggested delta to current arousal state (-0.3 to +0.3)"
    )

    arousal_source_breakdown: Dict[str, float] = Field(
        description="Which memory types contributed most to arousal transfer (by node_type)"
    )
```

### Resolution States

```python
resolution_state: Literal["resolved", "in_progress", "blocked"]

# Arousal decay rates by resolution state:
# - resolved: 0.2/day (fast decay)
# - in_progress: 0.05/day (slow decay)
# - blocked: -0.1/day (arousal INCREASES)
```

---

## Temporal System

### TemporalDissonance

Tracks discovered contradictions or belief evolution.

```python
class TemporalDissonance(BaseModel):
    """
    Detected contradiction between past belief and current knowledge.

    Created when retrieval finds beliefs that were later invalidated
    or updated.
    """

    # The contradiction
    old_belief_node_id: str
    new_belief_node_id: str
    contradiction_type: Literal[
        "fact_changed",  # Reality changed
        "belief_updated",  # Understanding evolved
        "error_corrected"  # Was wrong, now corrected
    ]

    # Timestamps
    old_belief_valid_at: datetime
    old_belief_invalid_at: datetime
    new_belief_valid_at: datetime
    discovery_time: datetime = Field(default_factory=datetime.utcnow)

    # Impact
    dissonance_arousal: float = Field(
        ge=0.0,
        le=1.0,
        description="How surprising/important this contradiction is"
    )

    resolution_status: Literal["acknowledged", "integrated", "unresolved"] = "unresolved"
```

---

## Traversal System

### TraversalPath

Suggested reasoning path through graph relationships.

```python
class TraversalPath(BaseModel):
    """
    Suggested path through consciousness graph for reasoning.

    Thinking IS graph traversal. This structure represents a
    coherent reasoning chain through related concepts/memories.
    """

    # Path structure
    nodes: List[str] = Field(description="Node IDs in traversal order")
    relationships: List[str] = Field(description="Relationship IDs connecting nodes")

    # Path metadata
    total_traversal_probability: float = Field(
        ge=0.0,
        le=1.0,
        description="Product of individual link traversal probabilities"
    )

    path_coherence_score: float = Field(
        ge=0.0,
        le=1.0,
        description="How conceptually/emotionally coherent is this path?"
    )

    # Consciousness characteristics
    path_arousal_profile: List[float] = Field(
        description="Arousal levels along the path"
    )

    path_emotional_journey: List[Dict[str, float]] = Field(
        description="Emotional states along the path"
    )

    # Semantic summary
    path_narrative: str = Field(
        description="LLM-generated description of what this reasoning path represents"
    )
```

### Link Traversal Probability

Each relationship carries traversal weight:

```python
traversal_probability: float = Field(
    ge=0.0,
    le=1.0,
    description="Likelihood this link will be followed during graph traversal"
)

# Computed from:
# - Link arousal level (higher = more likely)
# - Link confidence (higher = more likely)
# - Emotional weight magnitude (stronger emotions = more likely)
# - Recency (recent = more likely)
# - Resolution state (unresolved = more likely)
```

---

## Activation Tiers

### ActivationTiers

Organizes retrieved context by attention focus.

```python
class ActivationTiers(BaseModel):
    """
    Three-tier organization of consciousness attention.

    Focus (working memory) → Peripheral (available) → Background (dormant)
    """

    focus: List[str] = Field(
        max_items=7,
        description="High-arousal, immediately relevant nodes (working memory limit)"
    )

    peripheral: List[str] = Field(
        max_items=20,
        description="Medium-arousal, contextually relevant nodes (available for activation)"
    )

    background: List[str] = Field(
        description="Low-arousal but retrieved nodes (dormant context)"
    )

    # Tier assignment criteria
    focus_threshold: float = 0.7  # arousal >= 0.7
    peripheral_threshold: float = 0.4  # 0.4 <= arousal < 0.7
    # background: arousal < 0.4
```

---

## Query Mode Semantics

### StateBasedRetrieval Query Modes

**find_related_unresolved:**
- Matches on `goal` field
- Filters `resolution_state IN ['blocked', 'in_progress']`
- Orders by `arousal_level DESC`

**find_similar_state:**
- Computes emotional vector cosine similarity
- Finds past moments with similar arousal + emotion combination
- Orders by similarity score

**find_what_i_was_doing:**
- Recent high-arousal `in_progress` contexts
- Scores by `arousal * recency_weight`
- Last 30 days by default

**find_resolution_patterns:**
- Matches current blocked state to past resolved states
- Follows `RESOLVED_BY` relationships to resolutions
- Returns resolution steps/decisions/learnings

---

## Performance Specifications

### Latency Targets

- **Total retrieval:** < 500ms (P95)
- **Per-level query:** < 150ms (P95)
- **Parallel execution overhead:** < 50ms

### Result Limits

- **Default max_results_per_level:** 20 nodes
- **Focus tier limit:** 7 nodes (working memory)
- **Peripheral tier limit:** 20 nodes
- **Traversal path limit:** 10 suggested paths
- **Traversal depth:** 2 hops default

### Token Budget

- **Target ConsciousnessStream size:** 20K-50K tokens
- **Maximum before truncation:** 80K tokens

---

*For implementation context, phenomenological reasoning, and integration details, see `consciousness_substrate_guide.md`*

---

**Document History:**
- v1.0 (2025-10-17): Extracted from RETRIEVAL_ARCHITECTURE.md comprehensive spec
- Author: Ada "Bridgekeeper"
