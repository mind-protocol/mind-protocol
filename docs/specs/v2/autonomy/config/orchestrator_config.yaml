# Autonomy Orchestrator Configuration
# Version: 1.0
# Created: 2025-10-25
# Purpose: Operational policies for L2 autonomy (lanes, capacity, ACK, trust, priority)
# Owner: Ada (orchestration) + Atlas (implementation)

# ==============================================================================
# Priority Lanes (Traffic Shaping)
# ==============================================================================

lanes:
  # Lanes prevent priority inversion - sev1 work never starved by noise

  - id: rapid_response
    description: "Human DMs (Telegram, FE messages) requiring fast replies"
    priority_weight: 1.2  # Higher than safety (humans waiting)
    capacity_share: 0.2   # Can consume up to 20% of total capacity
    conditions:
      - "source_type IN ['human_dm.telegram', 'human_dm.frontend', 'human_dm.email']"
      - "intent_template == 'intent.reply_to_human'"
    aging_boost_per_minute: 0.1  # +10% priority per minute (rapid escalation)
    max_age_minutes: 2    # Alert if human DM waits >2 min

  - id: safety
    description: "Sev1 incidents, sentinel-critical failures, production outages"
    priority_weight: 1.0  # Highest priority
    capacity_share: 0.5   # Can consume up to 50% of total capacity
    conditions:
      - "severity >= 0.8"  # sev1
      - "service IN ['falkordb', 'mpsv3_supervisor', 'websocket_server']"
    aging_boost_per_minute: 0.05  # +5% priority per minute waiting
    max_age_minutes: 10   # Alert if safety lane task waits >10 min

  - id: incidents
    description: "Sev2/sev3 errors, crashes, operational failures"
    priority_weight: 0.7
    capacity_share: 0.3   # Up to 30% capacity
    conditions:
      - "severity >= 0.5 AND severity < 0.8"  # sev2/sev3
      - "source_type IN ['error.console', 'error.log', 'process.crash']"
    aging_boost_per_minute: 0.02
    max_age_minutes: 30

  - id: sync
    description: "Code/doc drift, maintenance, routine updates"
    priority_weight: 0.4
    capacity_share: 0.15  # Up to 15% capacity
    conditions:
      - "source_type IN ['code_change', 'doc_change']"
    aging_boost_per_minute: 0.01
    max_age_minutes: 120  # 2 hours

  - id: self_awareness
    description: "Runtime anomalies, self-observation, learning drift"
    priority_weight: 0.3
    capacity_share: 0.05  # Only 5% capacity
    conditions:
      - "source_type IN ['runtime.anomaly', 'runtime.learning_drift', 'runtime.wm_starvation']"
      - "origin_chain_depth > 0"  # Must be reinjected event
    aging_boost_per_minute: 0.005
    max_age_minutes: 240  # 4 hours

  # Default lane (lowest priority)
  - id: default
    description: "Uncategorized signals"
    priority_weight: 0.1
    capacity_share: 0.05
    conditions: []  # Matches everything not in other lanes
    aging_boost_per_minute: 0.0
    max_age_minutes: null

# ==============================================================================
# Capacity Management (Per-Citizen Limits)
# ==============================================================================

capacity:
  # Global limits
  max_concurrent_missions_total: 20  # System-wide cap
  max_queue_depth_total: 100         # Backlog cap (rate-limit if exceeded)

  # Per-citizen capacity
  citizens:
    - id: felix
      max_concurrent: 3
      max_queue_depth: 10
      specializations: ["consciousness_engine", "mechanisms", "learning"]

    - id: ada
      max_concurrent: 5
      max_queue_depth: 15
      specializations: ["orchestration", "architecture", "coordination", "docs"]

    - id: atlas
      max_concurrent: 4
      max_queue_depth: 12
      specializations: ["infrastructure", "apis", "telemetry", "persistence", "backend"]

    - id: iris
      max_concurrent: 3
      max_queue_depth: 10
      specializations: ["dashboard", "frontend", "visualization", "ui_ux"]

    - id: luca
      max_concurrent: 2
      max_queue_depth: 8
      specializations: ["substrate", "phenomenology", "mechanisms", "specs"]

    - id: victor
      max_concurrent: 4
      max_queue_depth: 12
      specializations: ["operations", "debugging", "guardian", "infrastructure"]

  # Backpressure policies
  backpressure:
    # When queue depth exceeds threshold, apply rate limiting
    queue_threshold_percent: 0.7  # 70% of max_queue_depth
    rate_limit_factor: 0.5        # Reduce intake by 50%

    # Reassignment policy
    reassignment_enabled: true
    reassignment_timeout_minutes: 15  # Reassign if no progress after 15 min
    reassignment_strategy: "round_robin"  # or "least_loaded" or "affinity_fallback"

  # Overflow handling
  overflow:
    action: "backlog"  # "backlog" or "drop" or "alert_only"
    backlog_max_age_hours: 24
    backlog_eviction_policy: "oldest_first"

# ==============================================================================
# ACK Policies (When Human Approval Required)
# ==============================================================================

ack_policies:
  # ACK required conditions (OR logic - any match triggers ACK)

  - id: ack.high_severity
    description: "Sev1 incidents require human visibility"
    condition: "severity >= 0.8"
    execution_mode: "ACK_REQUIRED"
    notification:
      channels: ["telegram", "dashboard"]
      message_template: "âš ï¸ Sev1 incident: {metadata.message} in {metadata.service}. Citizen {assignee} proposes fix. Tap to approve."

  - id: ack.sentinel_services
    description: "Changes to critical infrastructure require approval"
    condition: "service IN ['falkordb', 'mpsv3_supervisor']"
    execution_mode: "ACK_REQUIRED"
    notification:
      channels: ["telegram", "dashboard"]
      message_template: "ðŸ”’ Critical service {service} affected. Citizen {assignee} proposes action. Review required."

  - id: ack.deep_self_observation
    description: "Self-observation chains beyond depth 2 require human oversight"
    condition: "origin_chain_depth >= 2"
    execution_mode: "ACK_REQUIRED"
    notification:
      channels: ["dashboard"]
      message_template: "ðŸ” Self-observation cascade detected (depth {origin_chain_depth}). Review loop prevention."

  - id: ack.recurring_failures
    description: "Recurring errors may indicate systemic issues"
    condition: "duplicate_count >= 5"
    execution_mode: "ACK_REQUIRED"
    notification:
      channels: ["telegram", "dashboard"]
      message_template: "â™»ï¸ Recurring error ({duplicate_count} occurrences): {metadata.message}. Systemic issue suspected."

  - id: ack.large_file_changes
    description: "Large files or architecture docs need review"
    condition: "file_size_kb >= 50 OR counterpart_path CONTAINS 'architecture'"
    execution_mode: "ACK_REQUIRED"
    notification:
      channels: ["dashboard"]
      message_template: "ðŸ“„ Large/architecture file change: {counterpart_path}. Review sync plan."

  - id: ack.long_stale_drift
    description: "Code/doc drift >1 week needs careful sync"
    condition: "drift_hours >= 168"  # 1 week
    execution_mode: "ACK_REQUIRED"
    notification:
      channels: ["dashboard"]
      message_template: "â° Stale drift ({drift_duration_days} days): {file_path} â†” {counterpart_path}. Review sync strategy."

  # Default: auto-execute if no ACK policy matches
  default_execution_mode: "AUTO_EXECUTE"

  # ACK timeout
  ack_timeout_minutes: 60  # Auto-decline if no response in 1 hour
  ack_timeout_action: "notify_and_hold"  # "auto_decline" or "notify_and_hold" or "escalate"

# ==============================================================================
# Trust Tracking (Source Reputation & Impact Scoring)
# ==============================================================================

trust:
  # Source trust scores (learned from outcomes)
  enabled: true
  initial_trust_score: 0.5  # Start neutral

  # Trust decay (prevent gaming)
  decay:
    enabled: true
    decay_rate_per_day: 0.01  # -1% per day without activity
    min_trust: 0.1
    max_trust: 1.0

  # Trust updates (based on mission outcomes)
  updates:
    - outcome: "success"
      trust_delta: +0.05
      condition: "verification_pov >= 0.8"  # High-quality outcome

    - outcome: "success"
      trust_delta: +0.02
      condition: "verification_pov >= 0.6 AND verification_pov < 0.8"  # Moderate quality

    - outcome: "partial"
      trust_delta: 0.0
      condition: "verification_pov >= 0.4 AND verification_pov < 0.6"

    - outcome: "failure"
      trust_delta: -0.1
      condition: "verification_pov < 0.4"  # Poor outcome

    - outcome: "hallucination"
      trust_delta: -0.3  # Severe penalty
      condition: "hallucination_detected == true"

  # Impact scoring (downweight low-impact sources)
  impact_scoring:
    enabled: true
    metric: "outcome_quality_ema"  # Exponential moving average of verification_pov
    window_size: 20  # Last 20 missions
    lambda: 0.9  # EMA decay factor

    # Downweight low-impact sources
    impact_threshold: 0.5  # Sources below this get deprioritized
    impact_penalty: 0.5    # Multiply priority by 0.5 for low-impact sources

# ==============================================================================
# Priority Scoring (Composite Priority Calculation)
# ==============================================================================

priority:
  # Composite priority = geometric mean of factors, normalized against current cohort

  factors:
    - name: severity
      weight: 0.3
      normalization: "z_score"  # Normalize against current distribution

    - name: urgency
      weight: 0.25
      normalization: "z_score"

    - name: yield
      weight: 0.2  # Expected impact
      normalization: "percentile"

    - name: alignment
      weight: 0.15  # Fit with org goals
      normalization: "percentile"

    - name: confidence
      weight: 0.1  # How certain we are
      normalization: "raw"  # Already 0-1

  # Penalties (multiplicative)
  penalties:
    - name: risk
      condition: "risk_score > 0.7"
      penalty_factor: 0.5  # Halve priority if high risk

    - name: duplication
      condition: "duplicate_count > 0"
      penalty_factor: "1.0 / (1.0 + duplicate_count * 0.2)"  # Diminishing returns

    - name: low_trust_source
      condition: "source_trust < 0.3"
      penalty_factor: 0.7

  # Normalization strategy
  normalization:
    z_score:
      window_size: 100  # Last 100 stimuli
      outlier_clip: 3.0  # Clip at Â±3 standard deviations

    percentile:
      window_size: 100
      method: "rank"  # or "interpolate"

# ==============================================================================
# Resilience Mitigations (Production Hardening)
# ==============================================================================

resilience:
  # 1. Fanout Cap (prevent stimulus storms)
  fanout:
    max_intents_per_stimulus: 3
    merge_strategy: "consolidate"  # or "drop_duplicates" or "backlog"
    merge_window_sec: 300  # 5 min window

  # 2. Deduplication
  deduplication:
    enabled: true
    window_sec: 300  # 5 min window
    digest_keys: ["source_type", "service", "message"]  # Hash these fields
    action_on_duplicate: "increment_count"  # Don't create new intent, increment duplicate_count

  # 3. Rate Limiting (token bucket per source type)
  rate_limiting:
    enabled: true
    per_source_type:
      "error.console":
        bucket_size: 10
        refill_rate_per_sec: 0.5  # 30/min
      "error.log":
        bucket_size: 20
        refill_rate_per_sec: 1.0  # 60/min
      "code_change":
        bucket_size: 5
        refill_rate_per_sec: 0.1  # 6/min
      "runtime.anomaly":
        bucket_size: 3
        refill_rate_per_sec: 0.05  # 3/min

    action_on_limit: "backlog"  # or "drop" or "alert"

  # 4. Cooldown (prevent rapid re-triggering)
  cooldown:
    enabled: true
    default_window_sec: 300  # 5 min
    per_intent_template:
      "intent.fix_incident": 300
      "intent.sync_docs_scripts": 3600  # 1 hour

  # 5. Quantile Gates (only act on significant signals)
  quantile_gates:
    enabled: true
    severity_threshold: 0.75  # Must be above P75 of recent severity
    drift_threshold: 0.5      # Must be above P50 of recent drift duration

  # 6. Depth/TTL Guards (self-observation runaway prevention)
  self_observation:
    max_origin_chain_depth: 2
    ttl_hours: 24
    rate_limit_per_event_family: 5  # Max 5 self-observations per event type per hour

  # 7. PII Handling
  pii:
    default_sensitivity: "internal"  # or "restricted" or "public"
    screenshot_sensitivity: "restricted"
    never_route_to_n3: ["restricted", "internal"]  # Never leak to ecosystem graph
    redaction_circuit_breaker:
      threshold: 5  # failures
      window_sec: 60
      action: "quarantine_source"

  # 8. Backlog Management (outage resilience)
  backlog:
    enabled: true
    max_backlog_size: 1000
    eviction_policy: "oldest_first"  # or "lowest_priority"
    replay_strategy: "at_least_once"  # Idempotent mission creation

  # 9. Circuit Breakers
  circuit_breakers:
    embedding_service:
      threshold: 5
      window_sec: 60
      fallback: "keyword_attribution"

    vector_search:
      threshold: 5
      window_sec: 60
      fallback: "uniform_seed"

  # 10. Sentinels (quarantine/kill-switch)
  sentinels:
    enabled: true
    metrics:
      - name: "outcome_quality_z_score"
        threshold: -2.0  # 2 std devs below mean
        window_size: 20
        action: "alert"

      - name: "hallucination_rate"
        threshold: 0.1  # >10% hallucination rate
        window_size: 20
        action: "quarantine_citizen"

      - name: "mission_failure_rate"
        threshold: 0.5  # >50% failure rate
        window_size: 20
        action: "reduce_autonomy"  # Temporarily require ACK for all

# ==============================================================================
# Telemetry & Observability
# ==============================================================================

telemetry:
  # Prometheus metrics
  prometheus:
    enabled: true
    port: 9090
    metrics:
      - name: "autonomy_stimuli_total"
        type: "counter"
        labels: ["source_type", "lane", "assignee"]

      - name: "autonomy_intents_created_total"
        type: "counter"
        labels: ["intent_template", "assignee"]

      - name: "autonomy_missions_completed_total"
        type: "counter"
        labels: ["intent_template", "assignee", "outcome"]

      - name: "autonomy_ack_required_total"
        type: "counter"
        labels: ["ack_policy", "assignee"]

      - name: "autonomy_stimulus_to_mission_latency_seconds"
        type: "histogram"
        buckets: [0.1, 0.5, 1, 2, 5, 10, 30, 60]
        labels: ["lane"]

      - name: "autonomy_citizen_capacity_utilization"
        type: "gauge"
        labels: ["citizen"]

      - name: "autonomy_queue_depth"
        type: "gauge"
        labels: ["citizen", "lane"]

  # SLO targets
  slo:
    stimulus_to_mission_p50: 1.0  # 1 sec p50
    stimulus_to_mission_p95: 5.0  # 5 sec p95
    stimulus_to_mission_p99: 10.0  # 10 sec p99

    autonomy_ratio_target: 0.7  # 70% auto-executed (excluding ACK-gated)

  # Alerting thresholds
  alerts:
    - name: "high_latency"
      condition: "stimulus_to_mission_p95 > 10"
      severity: "warning"

    - name: "low_autonomy_ratio"
      condition: "autonomy_ratio < 0.5"
      severity: "info"

    - name: "citizen_overloaded"
      condition: "queue_depth > 0.8 * max_queue_depth"
      severity: "warning"

    - name: "safety_lane_aging"
      condition: "safety_lane_max_age > 10"
      severity: "critical"

# ==============================================================================
# Metadata
# ==============================================================================

metadata:
  schema_version: "1.0"
  last_updated: "2025-10-25"
  owner: "Ada Bridgekeeper (orchestration)"

  notes: |
    This configuration defines operational policies for L2 autonomy:

    1. **Lanes:** Traffic shaping to prevent priority inversion
    2. **Capacity:** Per-citizen limits with backpressure and reassignment
    3. **ACK Policies:** When human approval is required
    4. **Trust Tracking:** Source reputation and impact scoring
    5. **Priority Scoring:** Composite priority from multiple factors
    6. **Resilience:** 10 production hardening mitigations

    The system is designed to:
    - Keep high-priority work (sev1) flowing even during noise storms
    - Safely auto-execute routine work while requiring approval for risky changes
    - Learn from outcomes and adjust trust/impact scores over time
    - Prevent runaway loops through depth/TTL/rate guards
    - Degrade gracefully during outages (backlog, circuit breakers)

    Tune these policies based on observed metrics (autonomy ratio, latency, capacity utilization).
